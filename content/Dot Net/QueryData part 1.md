![[Pasted image 20241208233134.png]]

![[Pasted image 20241208233138.png]]

![[Pasted image 20241208233141.png]]

خوب ارتباط یک به چند داریم توی post یعنی یک پست میتونه چندین تا comment و چندین تا Tag داشته باشه  و یک relation هم با catogery داره 

![[Pasted image 20241208233149.png]]

هر catogery ارتباط یک به چند با هر پست داره  

![[Pasted image 20241208233157.png]]

در قسمت comment هم ارتباط داره با post و user

![[Pasted image 20241208233207.png]]

قسمت tag هم ارتباط یک به چند داره با post

![[Pasted image 20241208233217.png]]

![[Pasted image 20241208233223.png]]اینجا با دستور tolist اومدیم دیتا های post رو از دیتابیس گرفتیم و بعد ریختیمش توی post

![[Pasted image 20241208233237.png]]

حالا ما میخوایم دستورات sql که توسط ef ایجاد میشن رو ببینیم ، برای این کار میایم از  toQueryString استفاده میکنیم 

![[Pasted image 20241208233248.png]]

![[Pasted image 20241208233252.png]]

یه روش دیگه استفاده از sql profiler خوده sql server استفاده کنیم

![[Pasted image 20241208233300.png]]

بعد از connect شدن به اون سروری که میخوایم 

![[Pasted image 20241208233309.png]]

تمامی query هایی که روی این دیتابیس اعمال شده رو به ما نشون میده 

![[Pasted image 20241208233319.png]]

حالا میام یه query مینویسیم که بریم اونور چک کنیم 

![[Pasted image 20241208233327.png]]


خوب حالا میتونیم برای query هایی که توسط ef اجرا میشن میتونیم comment بنویسیم که موقع دیباگینگ ازش استفاده کنیم 

![[Pasted image 20241208233335.png]]اینجوری کامنت هم براش مینویسیم

![[Pasted image 20241208233341.png]]
دستورات linq رو هم میتونیم استفاده کنیم 

![[Pasted image 20241208233354.png]]خوب حالا دوباره برمیگردیم به همین دستور :

![[Pasted image 20241208233403.png]]

اینجا دیتای post فقط لود شده ولی دیتا هیچکدوم از relation هایی که داریم لود نشده 
برای لود کردن این موارد چند تا روش داریم 

![[Pasted image 20241208233433.png]]

این روش اسمش eager loading هستش :

![[Pasted image 20241208233444.png]]

اینطوری قسمت کامنت های پست ها هم باهاش لود میشن 
خوب برای لود کردن بقیه realtion ها میتونیم اون های دیگه رو هم include کنیم


![[Pasted image 20241208233453.png]]

حالا به طور مثال اینجا میخوایم وقتی که کامنت ها لود شد بریم ببینیم این کامنت توسط  کدوم user نوشته شده 

![[Pasted image 20241208233501.png]]

از دستور then include استفاده میکنیم
خوب میخوایم کامنت ها رو لود کنیم و بریزیم توی یه لیست

![[Pasted image 20241208233512.png]]

خوب اینجا یه دستور خیلی طولانی از tsql ها نوشته شده ، ولی در ef این قابلیت رو داریم که بیایم یه کاری کنیم که تیکه تیکه بهمون نشون بده و این باعث میشه که performance بهتری داشته باشیم
برای این کار باید از asSplitQuery استفاده میکنیم

![[Pasted image 20241208233520.png]]

اینجا یه بار پست ها رو لود کرده 

![[Pasted image 20241208233848.png]]

یک بار هم کامنت ها رو 

![[Pasted image 20241208233922.png]]

خوب حالا فرض کنیم که میخوایم از بین 1000 تا کامنت فقط 800 تاش که تاییدشده اند رو بگیریم 
برای این کار باید بیام فیلتر بزنیم :

![[Pasted image 20241208233935.png]]

میرسیم به مدل expilicit loading 
اینجا وقتیه که اول میام یه پست رو لود میکنیم و بعد میخوایم اگر مثلا یه شرطی برقرار بود بعدش بیایم کامنتهاش رو لود کنیم 
خوب همونطوری که میبینید post با comment رابطه چند تایی داره برای همین میایم از collection استفاده میکنیم 
برای post با category چون تکی هستش رابطه اش از reference استفاده میکنیم

![[Pasted image 20241208233950.png]]

![[Pasted image 20241208233956.png]]


خوب نکته ای که وجود داره وقتی که ما میخوایم فقط تعداد کامنت ها رو لود کنیم این روش درست نیست که بیایم کل دیتا کامنت ها رو بگیریم و لود کنیم توی برنامه و فقط بیایم تعدادش رو استفاده کنیم چون این باعث اضافه و سربار در برنامه میشه 

![[Pasted image 20241208234007.png]]


خوب راه حلی که هست اینه که یا بیایم تعداد کامنت ها رو با یه query جدا بگیرم 
بهتره که اینطوری بیایم بنویسیم 

![[Pasted image 20241208234027.png]]

و حتی میتونیم تعیین کنیم که کامنت هایی که فقط تایید شده اند رو نشون بده 

![[Pasted image 20241208234046.png]]

خوب این قضیه explicit loading برای زمانی که include و  then include به ef اضافه نشده بود استفاده میشد و بعدش دیگه نیازی به این مدل لود کردن دیتا ها به این شکل نداریم 
الان با استفاده از include و then include میایم همونجا شرط هایی که میخوایم دیتا لود بشن رو مینویسیم و ازشون استفاده میکنیم این قابلیت از ef 5 به بعد اضافه شده 
حالا بازم اگر شرط خاصی بود میتونیم از همین استفاده کنیم !

روش lazy loading توی این روش میاد وقتی که ما مثلا یه پست رو لود میکنیم خودش میاد اتوماتیک تمام relation های مرتبط با اون رو میاد لود میکنه 

![[Pasted image 20241208234058.png]]

![[Pasted image 20241208234100.png]]
با این روش روی تمام query ها lazy loading اعمال میشه 
نکته ای که داره اینه که برای استفاده ازش باید بر روی تمامی روابط باید virtual رو اضافه کنیم 


![[Pasted image 20241208234111.png]]

![[Pasted image 20241208234146.png]]

و بقیه شون هم باید virtual رو داشته باشن 

خوب حالا فرض کنید که برای post فقط میخوایم قسمت comment اش رو لود کنیم :
خوب اول که اون قسمتی که توی option nuilder هستش رو پاک میکنم و بعد میایم اینجوری مینویسیم
اول باید یه backing field برای comment درست کنیم، اینطوری که با استفاده از _ خوده convention ها تشخیص اش میده  
اینجا اومدیم یه نمونه از Ilazyloader درست کردیم و بعد اومدیم تزریق وابستگی رو انجام دادیم 

![[Pasted image 20241208234206.png]]

بعد میام get و set اش رو هم اینطوری تعیین میکنیم 

![[Pasted image 20241208234220.png]]

توی entity هم میشه تزریق وابستگی انجام داد


![[Pasted image 20241208234631.png]]
خوب اینجا کامنت ها لود شده ولی بقیه relation ها لود نشدن 
